name: Build & SonarQube

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: read

jobs:
  build:
    name: GCC 15 • Build • Test • Coverage • Sonar
    runs-on: ubuntu-latest

    # Use a container that already has GCC 15
    container:
      image: gcc:15

    env:
      # Must match your sonar-project.properties:
      # sonar.cfamily.compile-commands=build/bw-output/compile_commands.json
      BUILD_WRAPPER_OUT_DIR: build/bw-output
      CTEST_OUTPUT_ON_FAILURE: "1"

    steps:
      - name: Install prerequisites (cmake, ninja, coverage tools, git, ca-certs)
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            cmake ninja-build gcovr lcov git ca-certificates
          update-ca-certificates

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Toolchain sanity check
        run: |
          gcc --version
          g++ --version
          gcov --version || true
          ninja --version
          cmake --version

      - name: Install Sonar Build Wrapper
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v6

      - name: Configure (CMake • Debug • Ninja • GCC 15)
        env:
          CC: gcc
          CXX: g++
        run: |
          rm -rf build "${BUILD_WRAPPER_OUT_DIR}"
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_C_COMPILER="${CC}" \
            -DCMAKE_CXX_COMPILER="${CXX}"

      # Wrap ONLY the compile step (best practice)
      - name: Build (wrapped for Sonar C/C++)
        run: |
          build-wrapper-linux-x86-64 --out-dir "${BUILD_WRAPPER_OUT_DIR}" \
            cmake --build build -j"$(ninja -j 0 -v >/dev/null 2>&1 || nproc)"

      - name: Test
        run: |
          ctest --test-dir build --output-on-failure

      # Your CMake "coverage" target should emit build/sonarqube-coverage.xml
      # and use gcov from GCC 15 (in this container, `gcov` is GCC 15 already).
      - name: Coverage
        run: |
          cmake --build build --target coverage

      # Scanner will read sonar-project.properties at repo root
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          # If not configured org-wide, also set:
          # SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}